name: Split Markdown into Chunks

on:
  schedule:
    - cron: '0 1 * * *'  # Runs daily at 01:00 UTC
  workflow_dispatch:      # Allows manual triggers from the Actions tab

jobs:
  combine-and-split-markdown:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Combine .md files in chunks of 200
        run: |
          # Safely remove old chunk files (if any), ignoring errors if none are found
          rm -f BusinessCentralDocumentation_part_*.md || true
          
          count=0
          file_index=1
          output_file="BusinessCentralDocumentation_part_${file_index}.md"

          # Find only .md files in top-level 'business-central' (no subfolders)
          # Sort them alphabetically before iteration
          find business-central -maxdepth 1 -type f -name "*.md" | sort | while read -r f
          do
            # Extract filename (without .md extension)
            filename="$(basename "$f" .md)"

            # Start each article with the link to Microsoft Learn
            echo "Link to Microsoft Learn Page: https://learn.microsoft.com/dynamics365/business-central/$filename" >> "$output_file"
            
            # Append the original file contents
            cat "$f" >> "$output_file"
            
            # End of article
            echo "end of article" >> "$output_file"

            # Optional blank line for readability
            echo >> "$output_file"

            # Increment file counter
            ((count++))

            # If we've reached 200 articles, start a new file
            if [ "$count" -eq 200 ]; then
              ((file_index++))
              output_file="BusinessCentralDocumentation_part_${file_index}.md"
              count=0
            fi
          done

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add BusinessCentralDocumentation_part_*.md
          git commit -m "Combine markdown files in chunks of 200"
          git push || echo "No changes to push"
